---
title:  "DynamoDB 사용기"
excerpt: ""

categories:
  - Java
  - DB
tags:
  - DB
last_modified_at: 2021-03-22T017:45:00-05:00
---


# DynamoDB Entity 작성

Popup.java
```java
@Setter
@Getter
@SuppressWarnings("serial")
@ApiModel(description = "팝업 모델")
@DynamoDBTable(tableName="popup")
public class Popup extends BaseModel implements Serializable {

	@DynamoDBHashKey(attributeName="hk")
	@ApiModelProperty(notes = "pk")
	private String hk;

	@DynamoDBRangeKey(attributeName="sk")
	@ApiModelProperty(notes = "sk")
	private String sk;

	@DynamoDBIndexHashKey(attributeName="gsi01_hk", globalSecondaryIndexName = "gsi_popup_01")
	@ApiModelProperty(notes = "GSI01_HK")
	private String gsi01Hk;

	@DynamoDBIndexRangeKey(attributeName="gsi01_sk", globalSecondaryIndexName = "gsi_popup_01")
	@ApiModelProperty(notes = "GSI01_SK")
	private String gsi01Sk;

	@DynamoDBAttribute(attributeName="popup_no")
	@ApiModelProperty(notes = "팝업번호")
	private Integer popupNo;

	@DynamoDBAttribute(attributeName = "popup_nm")
	@ApiModelProperty(notes = "팝업명")
	private String popupNm;

	@DynamoDBIgnore
	@Getter(onMethod_ = { @DynamoDBTypeConvertedJson })
	@ApiModelProperty(notes = "지점JSON")
	private List<Store> storeJsn;

	@DynamoDBAttribute(attributeName="dp_strt_date")
	@ApiModelProperty(notes = "노출시작일시")
	@Getter(onMethod_ = { @DynamoDBTypeConverted(converter = DDBTimestampConverter.class) })
	private Timestamp dpStartDate;

	@DynamoDBAttribute(attributeName="dp_end_date")
	@ApiModelProperty(notes = "노출종료일시")
	@Getter(onMethod_ = { @DynamoDBTypeConverted(converter = DDBTimestampConverter.class) })
	private Timestamp dpEndDate;

}

```

BaseModel.java
```java
@Setter
@Getter
@DynamoDBDocument
public class DIBAPBaseModel implements Serializable {
	
	@SerializedName("reg_dttm")
	@DynamoDBAttribute(attributeName="reg_date")
	@ApiModelProperty(notes = "등록일시")
    @Getter(onMethod_ = { @DynamoDBTypeConverted(converter = DDBTimestampConverter.class) })
	private Timestamp regDate;

	@SerializedName("regr_no")
	@DynamoDBAttribute(attributeName="reg_no")
	@ApiModelProperty(notes = "등록자번호")
	private String regNo;

    @SerializedName("reg_dttm")
	@DynamoDBAttribute(attributeName="mod_date")
	@ApiModelProperty(notes = "수정일시")
    @Getter(onMethod_ = { @DynamoDBTypeConverted(converter = DDBTimestampConverter.class) })
	private Timestamp modDate;

	@SerializedName("regr_no")
	@DynamoDBAttribute(attributeName="mod_no")
	@ApiModelProperty(notes = "수정자번호")
	private String modNo;
}
```
- @DynamoDBTable(tableName = "popup"): 해당 클래스를 엔티티로 설정. DynamoDB 상 테이블은 popup.
- @DynamoDBHashKey(attributeName = "hk"): 해당 필드를 HashKey로 설정.
- @DynamoDBRangeKey(attributeName="sk"): 해당 필드를 SortKey로 설정.
- @DynamoDBAutoGeneratedKey: 자동으로 Key를 생성. UUID를 활용.
- @DynamoDBAttribute: 해당 필드를 Attribute로 설정. attributeName 은 디폴트로 해당 변수명으로 매핑. 값을 넣을 시 해당 값에 매핑.
- @DynamoDBTyped(DynamoDBAttributeType.BOOL): 해당 타입을 DynamoDB의 BOOL타입으로 설정.
- @DynamoDBIndexHashKey(attributeName="gsi01_hk", globalSecondaryIndexName = "gsi_popup_01"): gsi_popup_01 이름의 global secondary index의 HashKey를 설정. gsi01_hk 와 매핑.
- @DynamoDBIndexRangeKey(attributeName="gsi01_sk", globalSecondaryIndexName = "gsi_popup_01"): gsi_popup_01 이름의 global secondary index의 RangeKey를 설정. gsi01_sk 와 매핑.
- 눈여겨 볼 것은 xxDate 필드 위에 있는  @Getter(onMethod_ = { @DynamoDBTypeConverted(converter = DDBTimestampConverter.class) }) 어노테이션인데
Get 할 때에는 Timestamp type 을 보기 쉽게 화면에 뿌리기 위해 컨버터를 사용했다.


```java
@DynamoDBTypeConverted(converter = LocalDateTimeConverter.class)
private LocalDateTime regDate;
```
- 이와 마찬가지로 만약 소스 상에서 데이터 생성 시 Timestamp 를 사용하지 않고 LocalDateTime 을 사용했다면 위와 같이 해주면 가능하다. (DynamoDB 의 Date 는 Timestamp 사용)


# 항목 저장

```java
    // 항목 저장
    @Override
    public CommonDataModel<String> updatePopup(Popup popup, int popupNoSeq) throws Exception {

        Timestamp ts = new Timestamp (System.currentTimeMillis ());

        try {
            popupNoSeq = redisSequenceImpl.getSequence (Constant.SEQ_PPUPNO);
            popupNoSeq++;
            Integer ppupNoSeqTemp = this.getPopupSeqCount (Popup.class, Constant.POPUP_HK + ppupNoSeq, Constant.POPUP_SK);

            if(ppupNoSeqTemp > 0){
                throw new MyCommonException ("There is already the popup_no Sequence");
            }

            String hk = Constant.POPUP_HK + popupNoSeq;
            String sk = Constant.POPUP_SK;
            String gsi01Hk = Constant.POPUP_GSI01_HK;      // POPUP
            String gsi01Sk = Constant.POPUP_GSI01_SK + ts; // POPUP$2021-03-11 ...
            popup.setHk (hk);
            popup.setSk (sk);
            popup.setGsi01Hk (gsi01Hk);
            popup.setGsi01Sk (gsi01Sk);
            popup.setPoppupNo (popupNoSeq);
            popup.setRegNo ("dj");
            popup.setRegDate (ts);
            popup.setModNo ("dj");
            popup.setModDate (ts);

            dynamoDBMapper.save (popup);

        } catch (InterruptedException e) {
            // DynamoDB save 실패 시
            return new CommonDataModel<String> ("FAIL");
        }
        // save 성공 시 
        return new CommonDataModel<String>("SUCCESS");
    }
```

# 항목 조회

```java
    // 항목 조회
    @Override
    public CommonDataModel<String> getPopup(Integer popupNo) throws Exception {

        Timestamp ts = new Timestamp (System.currentTimeMillis ());

        try {
            String hk = Constant.POPUP_HK + popupNo;
            String sk = Constant.POPUP_SK;

            Popup popup = dynamoDBMapper.load(Popup.class, hk, sk);

        } catch (InterruptedException e) {
            // DynamoDB save 실패 시
            return new CommonDataModel<String> ("FAIL");
        }
        // save 성공 시 
        return new CommonDataModel<String>("SUCCESS");
    }
```

# 항목 삭제

```java
    // 항목 삭제
    @Override
    public CommonDataModel<String> deletePopup(Integer popupNo) throws Exception {

        try {
            String hk = Constant.POPUP_HK + popupNo;
            String sk = Constant.POPUP_SK;

            // 삭제 대상 조회
            Popup popup = dynamoDBMapper.load(Popup.class, hk, sk);
            // 삭제
            dynamoDBMapper.delete(popup);

        } catch (InterruptedException e) {
            // DynamoDB delete 실패 시
            return new CommonDataModel<String> ("FAIL");
        }
        // delete 성공 시 
        return new CommonDataModel<String>("SUCCESS");
    }
```