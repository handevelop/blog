---
title:  "S3 upload"
excerpt: ""

categories:
  - S3
  - 스터디
last_modified_at: 2020-07-01T08:06:00-05:00
---


객체 생성


JSONObject jsonObject = new JSONObject ();
int dispCatId = 1;
 
List<Map<String, Object>> catList = this.getDisplayCategory (param);
 
if(catList != null) {
   catList.stream ().forEach (el -> {
      Map<String, Object> result = this.getCornInfo (String.valueOf (el.get("dcatNo")));
      List<Map<String, Object>> cornList = null;
 
      //log.info("[DJ] cornInfo : " + result.toString ());
 
      if(MapUtils.isNotEmpty (result)) {
         cornList = (List<Map<String, Object>>) result.get("dpLnkDpTgtSetList");
         cornList = (List<Map<String, Object>>) cornList.get(0).get("dtgtJsn");
 
         //log.info ("1234 : " + cornList.toString ());
         cornList.forEach (pd -> {
            if ("PD".equals(String.valueOf(pd.get("dtgtDvsCd"))) && pd.get("dtgtDvsCd") != null
                  && MapUtils.isNotEmpty((Map) pd.get("pdList"))) {
               el.put("pdList", pd.get("pdList"));
            }
            if ("IMG".equals(String.valueOf(pd.get("dtgtDvsCd"))) && pd.get("dtgtDvsCd") != null
                  && StringUtils.isNotEmpty(String.valueOf(pd.get("dtgtDvsCd"))) && pd.get("imgFullUrl") != null) {
               el.put("imgFullUrl", pd.get("imgFullUrl"));
            }
         });
         el.put("dcatNo", result.get("dcornId"));
         el.put("dcornId", result.get("dcornId"));
      }
   });
   catList = catList.stream().filter(el -> MapUtils.isNotEmpty((Map) el.get("pdList"))).collect(Collectors.toList());
 
   for (Map<String, Object> cat : catList) {
      cat.put("dispCatId", String.valueOf(dispCatId++));
   }
}
 
//log.info ("[DJ] catList final : {} " + catList.toString ());
 
jsonObject.put ("catList", catList);
==> 저장하고자 할 JSONObject 객체 생성.





저장용 메소드


public void uploadJsonToPublicS3 (JSONObject jsonObject, String path, String fileNm) {
 
   ObjectMapper objectMapper = new ObjectMapper ();
 
   try {
      byte[] bytesToWrite = objectMapper.writeValueAsBytes (jsonObject);
      ObjectMetadata omd = new ObjectMetadata ();
      omd.setContentType (MediaType.APPLICATION_JSON_VALUE);
      omd.setContentLength (bytesToWrite.length);
 
      ByteArrayInputStream inputStream = new ByteArrayInputStream (bytesToWrite);
 
      PutObjectRequest putObjectRequest = new PutObjectRequest (publicBucketName, path + fileNm, inputStream, omd);
 
      s3Client.putObject (putObjectRequest);
      IOUtils.closeQuietly (inputStream, null);
 
   } catch (IOException e) {
      log.error ("error occur " + e.getMessage ());
   }
 
}
==> jsonObject : 저장할 객체, path : 버킷 하위에 지정할 경로, fileNm : 저장할 파일명

인풋스트림을 사용해 파일을 임시저장하지 않고 바로 putObject() 를 사용해 s3 에 저장한다.







사용 예제


dpFileUtility.uploadJsonToPublicS3 (jsonObject, "display/json/corner/", "cx_reco_product_comb_05.json");
==> {publicBucketName}/display/json/corner/cx_reco_product_comb_05.json 로 저장.